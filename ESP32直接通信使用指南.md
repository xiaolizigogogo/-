# ESP32 直接通信使用指南

## 概述
两个 ESP32 设备通过 WiFi 直接通信，无需外部路由器。使用 AP + Station 模式，一个设备作为热点，另一个设备连接。

## 方案选择

### 方案1：分离式程序（推荐）
- `ESP32_A_AP模式.ino` - 主设备（AP热点）
- `ESP32_B_Station模式.ino` - 从设备（连接热点）

### 方案2：通用程序
- `ESP32_简化UDP通信.ino` - 通过修改 `DEVICE_ROLE` 选择角色

## 使用步骤

### 步骤1：准备设备
1. 准备两个 ESP32 开发板
2. 确保都安装了 ESP32 开发板支持包

### 步骤2：上传程序
**方法A：使用分离式程序**
1. 将 `ESP32_A_AP模式.ino` 上传到第一个 ESP32
2. 将 `ESP32_B_Station模式.ino` 上传到第二个 ESP32

**方法B：使用通用程序**
1. 修改 `ESP32_简化UDP通信.ino` 中的 `DEVICE_ROLE`：
   - 设为 `1` 上传到第一个 ESP32（AP模式）
   - 设为 `2` 上传到第二个 ESP32（Station模式）

### 步骤3：启动设备
1. 先启动第一个 ESP32（AP模式）
2. 再启动第二个 ESP32（Station模式）
3. 观察串口输出

## 网络配置

### 默认配置
- **热点名称**: `ESP32_A` 或 `ESP32_Comm`
- **热点密码**: `12345678`
- **UDP端口**: `1234`
- **AP IP地址**: `192.168.4.1`
- **Station IP地址**: `192.168.4.2`

### 自定义配置
可以修改程序中的以下参数：
```cpp
const char* ap_ssid = "你的热点名称";
const char* ap_password = "你的密码";
const int udp_port = 1234;
```

## 通信测试

### 正常连接输出示例

**ESP32-A（AP模式）输出：**
```
==========================================
ESP32-A AP模式 - 主设备
==========================================
热点名称: ESP32_A
热点密码: 12345678
AP IP地址: 192.168.4.1
UDP端口: 1234

等待ESP32-B连接...
==========================================
发送心跳: 心跳: 5000
收到数据: Hello from ESP32-B: 3000
发送响应: ESP32-A收到: Hello from ESP32-B: 3000
```

**ESP32-B（Station模式）输出：**
```
==========================================
ESP32-B Station模式 - 从设备
==========================================
正在连接热点: ESP32_A
✓ 连接成功！
本机IP地址: 192.168.4.2
服务器IP: 192.168.4.1
UDP端口: 1234
==========================================
发送数据: Hello from ESP32-B: 3000
收到数据: 心跳: 5000
发送响应: ESP32-B收到: 心跳: 5000
```

## 故障排除

### 问题1：Station设备连接失败
**症状**: ESP32-B 显示"连接失败"
**解决方案**:
1. 确保 ESP32-A 已启动并创建热点
2. 检查热点名称和密码是否正确
3. 重启两个设备

### 问题2：无法接收数据
**症状**: 设备连接成功但无法通信
**解决方案**:
1. 检查 UDP 端口是否一致
2. 确保防火墙没有阻止 UDP 通信
3. 检查 IP 地址配置

### 问题3：编译错误
**症状**: `'WiFiUdp' does not name a type`
**解决方案**:
- 确保使用正确的类名 `WiFiUDP`（大写）

## 扩展功能

### 发送自定义数据
修改发送部分代码：
```cpp
String message = "你的自定义数据";
udp.beginPacket(target_ip, udp_port);
udp.print(message);
udp.endPacket();
```

### 处理接收数据
修改接收部分代码：
```cpp
if (packetSize) {
  char buffer[255];
  int len = udp.read(buffer, 255);
  if (len > 0) {
    buffer[len] = '\0';
    // 处理接收到的数据
    processReceivedData(String(buffer));
  }
}
```

## 优势
- ✅ 无需外部路由器
- ✅ 配置简单
- ✅ 实时通信
- ✅ 低延迟
- ✅ 代码简洁

## 注意事项
- 确保两个设备在 WiFi 信号范围内
- AP 模式设备会消耗更多电量
- 建议在测试环境中使用固定 IP 地址
- 生产环境中建议添加错误处理和重连机制
