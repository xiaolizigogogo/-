# ESP32 蓝牙互连测试指南

## 概述
本指南介绍如何使用两个ESP32设备进行蓝牙互连测试，验证ESP32之间的蓝牙通信功能。

## 硬件要求
- 2个ESP32开发板
- 2条USB数据线
- 2台电脑（或1台电脑的2个USB端口）

## 软件要求
- Arduino IDE
- 蓝牙库：`BluetoothSerial` (ESP32内置)
- JSON库：`ArduinoJson`

## 程序说明

### 1. 主设备程序 (`ESP32_蓝牙主设备.ino`)
- **功能**：主动搜索并连接从设备
- **设备名称**：ESP32_Master
- **目标设备**：ESP32_Slave
- **特点**：自动重连、状态监控

### 2. 从设备程序 (`ESP32_蓝牙从设备.ino`)
- **功能**：等待主设备连接
- **设备名称**：ESP32_Slave
- **配对密码**：1234
- **特点**：被动连接、响应命令

## 操作步骤

### 步骤1：准备硬件
1. 准备两个ESP32开发板
2. 分别连接到电脑的USB端口
3. 确保两个设备都能正常识别

### 步骤2：上传程序
1. **上传从设备程序**：
   - 选择第一个ESP32端口
   - 上传 `ESP32_蓝牙从设备.ino`
   - 打开串口监视器，确认程序运行正常

2. **上传主设备程序**：
   - 选择第二个ESP32端口
   - 上传 `ESP32_蓝牙主设备.ino`
   - 打开串口监视器，观察连接过程

### 步骤3：观察连接过程
1. **从设备启动**：
   - 显示"从设备已启动，等待主设备连接"
   - 蓝牙状态显示"未连接"

2. **主设备启动**：
   - 显示"开始搜索目标设备"
   - 尝试连接到ESP32_Slave
   - 连接成功后显示"蓝牙连接已建立"

### 步骤4：测试通信
连接成功后，可以通过串口监视器发送命令：

#### 主设备发送命令
- `test` - 测试通信
- `status` - 获取从设备状态
- `info` - 获取从设备系统信息
- `ping` - 测试响应速度
- `echo:消息` - 回显测试

#### 从设备响应
- 自动响应所有命令
- 发送JSON格式的响应数据
- 包含设备类型标识

## 预期结果

### 连接成功
```
主设备串口输出：
✓ 成功连接到: ESP32_Slave
✓ 蓝牙连接已建立

从设备串口输出：
✓ 蓝牙连接已建立
```

### 通信测试
```
主设备发送：test
从设备响应：{"type":"test_result","device":"slave","result":"success","message":"从设备通信正常"}
```

## 故障排除

### 问题1：主设备搜索不到从设备
**可能原因**：
- 从设备未正确启动
- 设备名称不匹配
- 蓝牙硬件问题

**解决方法**：
1. 检查从设备串口输出
2. 确认设备名称正确
3. 重启两个设备
4. 检查蓝牙硬件连接

### 问题2：连接建立后立即断开
**可能原因**：
- 电源供应不稳定
- 蓝牙信号干扰
- 程序逻辑错误

**解决方法**：
1. 检查电源供应
2. 调整设备位置
3. 检查代码逻辑
4. 重新上传程序

### 问题3：通信数据丢失
**可能原因**：
- 缓冲区溢出
- 数据传输速度过快
- JSON解析错误

**解决方法**：
1. 增加延迟时间
2. 检查JSON格式
3. 优化数据处理
4. 监控内存使用

## 高级功能

### 1. 自动重连
- 主设备检测到断开后自动重连
- 从设备等待主设备重新连接
- 保持通信的连续性

### 2. 状态监控
- 实时监控连接状态
- 定期发送心跳包
- 记录通信统计信息

### 3. 错误处理
- 完善的错误处理机制
- 详细的错误信息输出
- 自动恢复功能

## 扩展应用

### 1. 数据传输
- 传感器数据共享
- 文件传输
- 实时数据同步

### 2. 控制功能
- 远程控制
- 状态同步
- 命令转发

### 3. 网络扩展
- 多设备组网
- 中继功能
- 路由功能

## 注意事项

1. **设备距离**：保持设备在有效通信范围内
2. **电源稳定**：确保电源供应稳定
3. **干扰源**：避免强电磁干扰
4. **程序同步**：确保两个设备程序版本一致
5. **串口监控**：实时监控串口输出

## 技术支持

如遇问题，请提供：
1. 完整的串口输出日志
2. 硬件配置信息
3. 程序版本信息
4. 详细的错误描述
