# 无线控制盒系统架构说明

## 系统架构图

```
┌─────────────────┐   433MHz无线通信   ┌─────────────────┐
│   主控制盒      │◄─────────────────►│   无线控制盒    │
│ (MasterControl) │                   │ (WirelessControl)│
└─────────────────┘                   └─────────────────┘
         │                                      │
         │                                      │
    ┌────▼────┐                            ┌────▼────┐
    │ 硬件接口 │                            │ 硬件接口 │
    └────┬────┘                            └────┬────┘
         │                                      │
    ┌────▼────┐                            ┌────▼────┐
    │ 控制逻辑 │                            │ 控制逻辑 │
    └────┬────┘                            └────┬────┘
         │                                      │
    ┌────▼────┐                            ┌────▼────┐
    │ 通信模块 │                            │ 通信模块 │
    └─────────┘                            └─────────┘
```

## 系统组成

### 1. 主控制盒（MasterControlBox）

#### 核心功能
- **设备管理**：管理设备ID和配置信息
- **通信控制**：处理433MHz无线通信
- **状态同步**：与无线控制盒同步状态
- **硬件控制**：控制电机、舵机、LED等硬件

#### 主要模块
```
┌─────────────────────────────────────────┐
│              主控制盒系统                │
├─────────────────────────────────────────┤
│ 1. 设备配置管理模块                      │
│    - 设备ID管理                         │
│    - 配置信息存储                       │
│    - 参数记录和恢复                     │
├─────────────────────────────────────────┤
│ 2. 无线通信模块                          │
│    - 433MHz发送/接收                    │
│    - 指令解析和处理                     │
│    - 配对管理                           │
├─────────────────────────────────────────┤
│ 3. 硬件控制模块                          │
│    - 电机控制                           │
│    - 舵机控制                           │
│    - LED控制                            │
│    - 编码器读取                         │
├─────────────────────────────────────────┤
│ 4. 状态管理模块                          │
│    - 系统状态监控                       │
│    - 连接状态管理                       │
│    - 错误处理                           │
└─────────────────────────────────────────┘
```

### 2. 无线控制盒（WirelessControlBox）

#### 核心功能
- **远程控制**：接收和执行远程控制指令
- **状态反馈**：向主控制盒反馈状态信息
- **本地控制**：支持本地按钮和编码器控制
- **数据同步**：与主控制盒同步数据

#### 主要模块
```
┌─────────────────────────────────────────┐
│             无线控制盒系统               │
├─────────────────────────────────────────┤
│ 1. 远程控制模块                          │
│    - 指令接收和处理                     │
│    - 状态反馈                           │
│    - 连接管理                           │
├─────────────────────────────────────────┤
│ 2. 本地控制模块                          │
│    - 按钮控制                           │
│    - 编码器控制                         │
│    - 本地状态管理                       │
├─────────────────────────────────────────┤
│ 3. 通信模块                              │
│    - 433MHz发送/接收                    │
│    - 指令编码和解码                     │
│    - 配对管理                           │
├─────────────────────────────────────────┤
│ 4. 同步模块                              │
│    - 数据同步                           │
│    - 状态同步                           │
│    - 配置同步                           │
└─────────────────────────────────────────┘
```

## 通信协议

### 1. 指令格式

```
┌─────────┬─────────┬─────────┬─────────┐
│ 设备ID  │ 指令类型 │  参数   │ 校验码  │
│ (8位)   │ (8位)   │ (8位)   │ (8位)   │
└─────────┴─────────┴─────────┴─────────┘
```

### 2. 指令类型定义

| 指令类型 | 值 | 描述 | 参数说明 |
|---------|----|------|----------|
| CMD_LED_ON | 0x01 | 开启LED | 无 |
| CMD_LED_OFF | 0x02 | 关闭LED | 无 |
| CMD_MOTOR_FWD | 0x03 | 电机前进 | 速度值 |
| CMD_MOTOR_BWD | 0x04 | 电机后退 | 速度值 |
| CMD_MOTOR_STOP | 0x05 | 电机停止 | 无 |
| CMD_SERVO_LEFT | 0x06 | 舵机左转 | 角度值 |
| CMD_SERVO_RIGHT | 0x07 | 舵机右转 | 角度值 |
| CMD_SPEED_UP | 0x08 | 速度增加 | 增量值 |
| CMD_SPEED_DOWN | 0x09 | 速度减少 | 减量值 |
| CMD_STATUS | 0x0A | 状态查询 | 无 |
| CMD_RECORD | 0x0B | 记录参数 | 无 |
| CMD_RESET | 0x0C | 系统重置 | 无 |
| CMD_EMERGENCY_STOP | 0x0D | 紧急停止 | 无 |
| CMD_PAIR_REQUEST | 0x0E | 配对请求 | 设备ID |

### 3. 通信流程

#### 配对流程
```
1. 主控制盒发送配对请求
   ┌─────────┐   配对请求    ┌─────────┐
   │主控制盒 │ ───────────► │无线控制盒│
   └─────────┘              └─────────┘

2. 无线控制盒响应配对请求
   ┌─────────┐   配对响应    ┌─────────┐
   │主控制盒 │ ◄─────────── │无线控制盒│
   └─────────┘              └─────────┘

3. 建立连接
   ┌─────────┐   连接确认    ┌─────────┐
   │主控制盒 │ ◄───────────► │无线控制盒│
   └─────────┘              └─────────┘
```

#### 控制流程
```
1. 指令发送
   ┌─────────┐   控制指令    ┌─────────┐
   │主控制盒 │ ───────────► │无线控制盒│
   └─────────┘              └─────────┘

2. 指令执行
   ┌─────────┐   执行状态    ┌─────────┐
   │主控制盒 │ ◄─────────── │无线控制盒│
   └─────────┘              └─────────┘

3. 状态反馈
   ┌─────────┐   状态信息    ┌─────────┐
   │主控制盒 │ ◄─────────── │无线控制盒│
   └─────────┘              └─────────┘
```

## 数据流

### 1. 控制数据流

```
用户操作 → 按钮/编码器 → 控制逻辑 → 硬件控制 → 设备动作
    ↓
状态反馈 ← 状态监控 ← 硬件状态 ← 设备状态
```

### 2. 通信数据流

```
主控制盒 → 指令编码 → 无线发送 → 无线接收 → 指令解码 → 无线控制盒
    ↑                                                           ↓
状态反馈 ← 状态编码 ← 无线发送 ← 无线接收 ← 状态解码 ← 状态监控
```

### 3. 同步数据流

```
主控制盒状态 → 状态编码 → 无线发送 → 无线接收 → 状态解码 → 无线控制盒状态
    ↑                                                                  ↓
配置同步 ← 配置编码 ← 无线发送 ← 无线接收 ← 配置解码 ← 配置信息
```

## 状态管理

### 1. 系统状态

#### 主控制盒状态
- **空闲状态**：系统正常，等待指令
- **控制状态**：正在执行控制指令
- **配对状态**：正在进行设备配对
- **错误状态**：系统出现错误

#### 无线控制盒状态
- **未连接状态**：未与主控制盒连接
- **已连接状态**：已与主控制盒连接
- **配对状态**：正在进行配对
- **控制状态**：正在执行控制指令

### 2. 连接状态

#### 连接状态机
```
未连接 ──配对请求──► 配对中 ──配对成功──► 已连接
   ↑                                    │
   └──────────连接断开◄─────────────────┘
```

### 3. 错误处理

#### 错误类型
- **通信错误**：无线通信失败
- **硬件错误**：硬件设备故障
- **配置错误**：配置信息错误
- **超时错误**：操作超时

#### 错误处理策略
- **自动重试**：通信错误自动重试
- **状态恢复**：错误后自动恢复状态
- **用户通知**：通过LED和串口通知用户
- **安全保护**：紧急停止保护

## 性能指标

### 1. 通信性能
- **通信距离**：<50米（开阔环境）
- **通信速率**：9600bps
- **响应时间**：<100ms
- **可靠性**：>99%

### 2. 控制性能
- **控制精度**：±1度（舵机）
- **速度范围**：0-255（电机）
- **响应时间**：<50ms
- **稳定性**：>99.9%

### 3. 系统性能
- **功耗**：<500mA
- **工作温度**：-10°C ~ +50°C
- **工作湿度**：20% ~ 80% RH
- **使用寿命**：>5年

## 扩展性

### 1. 硬件扩展
- **多设备支持**：支持多个控制盒
- **接口扩展**：支持更多硬件接口
- **功能扩展**：支持新功能模块

### 2. 软件扩展
- **协议扩展**：支持新通信协议
- **功能扩展**：支持新控制功能
- **配置扩展**：支持新配置选项

### 3. 系统扩展
- **网络扩展**：支持网络通信
- **云端扩展**：支持云端控制
- **移动扩展**：支持移动设备控制
