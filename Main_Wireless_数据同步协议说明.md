# Main_Wireless 数据同步协议说明

## 概述
基于 Main(2).ino 业务逻辑的无线数据同步系统，主设备通过 WiFi 向子设备传输 EEPROM 数据。

## 系统架构

### 主设备 (Main_Wireless_Master_完整版.ino)
- **角色**: AP热点 + 业务逻辑控制器
- **功能**: 
  - 执行原始业务逻辑（舵机、电机、编码器控制）
  - 创建WiFi热点 "MainController"
  - 定时向子设备同步EEPROM数据
  - 响应子设备的数据请求

### 子设备 (Main_Wireless_Slave_完整版.ino)
- **角色**: Station客户端 + 数据接收器
- **功能**:
  - 连接主设备热点
  - 接收系统参数数据
  - 保存数据到本地EEPROM
  - 定期请求数据更新

## 网络配置

### WiFi设置
- **热点名称**: `MainController`
- **热点密码**: `12345678`
- **主设备IP**: `192.168.4.1`
- **子设备IP**: `192.168.4.2`
- **UDP端口**: `1234`

### 连接流程
1. 主设备启动，创建AP热点
2. 子设备连接主设备热点
3. 建立UDP通信
4. 开始数据同步

## 数据同步协议

### 1. 数据请求协议
```
子设备 → 主设备: "REQUEST_DATA"
主设备 → 子设备: JSON数据包
子设备 → 主设备: "CONFIRM_RECEIVED"
```

### 2. 定时同步协议
```
主设备每2秒检查数据变化
如有变化 → 主动发送数据到子设备
子设备接收 → 保存到EEPROM → 发送确认
```

### 3. JSON数据格式
```json
{
  "type": "SYSTEM_DATA",
  "timestamp": 12345,
  "steerAngle": 150.0,
  "steerSpeed": 25,
  "steerLTime": 5,
  "steerRTime": 5,
  "motorSpeed": 50,
  "steerMidVal": 1550,
  "steerAngle_show": 75,
  "SteerLeftTimeFlag": 0,
  "motorSw": true,
  "steerSw": false,
  "motorSwFlag": 1,
  "encoders": [100, 200, 150, 300, 80]
}
```

## EEPROM数据结构

### 地址映射
| 地址 | 参数 | 说明 |
|------|------|------|
| addr1 (0) | steerAngle | 舵机角度 |
| addr2 (1) | steerSpeed | 舵机速度 |
| addr3 (2) | steerLTime | 左转时间 |
| addr4 (3) | steerRTime | 右转时间 |
| addr5 (4) | motorSpeed | 电机速度 |
| addr6 (5) | ecCnt[0] | 编码器0 |
| addr7 (6) | ecCnt[1] | 编码器1 |
| addr8 (7) | ecCnt[2] | 编码器2 |
| addr9 (8) | ecCnt[4] | 编码器4 |
| addr10 (9) | ecCnt[3]%100 | 编码器3低字节 |
| addr101 (9) | ecCnt[3]/100 | 编码器3高字节 |
| addr11 (10) | steerMidVal%100 | 中位值低字节 |
| addr111 (11) | steerMidVal/100 | 中位值高字节 |
| addr12 (12) | SteerLeftTimeFlag | 状态标志 |
| addr18 (23) | steerAngle_show | 显示角度 |
| 200 | 数据有效标志 | 1=有效, 0=无效 |

## 业务逻辑保持

### 主设备保持的原始功能
1. **编码器控制**: 5个编码器输入处理
2. **按键控制**: 5个按键功能
3. **舵机控制**: 摆动控制逻辑
4. **电机控制**: 速度控制
5. **数码管显示**: 3个数码管状态显示
6. **EEPROM存储**: 参数保存和加载

### 数据变化检测
- 编码器值变化 → `dataChanged = true`
- 按键操作 → `dataChanged = true`
- 参数保存 → `dataChanged = true`

## 通信时序

### 正常通信流程
```
主设备启动 → 创建热点 → 执行业务逻辑
子设备启动 → 连接热点 → 请求数据
主设备发送 → JSON数据包 → 子设备接收
子设备保存 → EEPROM → 发送确认
主设备确认 → 继续业务逻辑
```

### 数据同步频率
- **主动同步**: 数据变化时立即发送
- **定时同步**: 每2秒检查一次
- **请求同步**: 子设备每5秒请求一次
- **超时检测**: 10秒无数据则重连

## 错误处理

### 连接异常
- 子设备连接失败 → 自动重试
- 连接超时 → 重新连接
- 数据丢失 → 重新请求

### 数据异常
- JSON解析错误 → 忽略数据包
- EEPROM写入失败 → 重试保存
- 数据校验失败 → 重新请求

## 使用说明

### 部署步骤
1. 上传 `Main_Wireless_Master_完整版.ino` 到主设备
2. 上传 `Main_Wireless_Slave_完整版.ino` 到子设备
3. 先启动主设备，再启动子设备
4. 观察串口输出确认连接成功

### 监控要点
- 主设备: 热点创建、数据发送、业务逻辑执行
- 子设备: 连接状态、数据接收、EEPROM保存
- 通信: JSON数据包、确认消息、错误处理

### 调试信息
- 主设备显示: 发送的数据包内容
- 子设备显示: 接收的数据、EEPROM验证
- 网络状态: 连接状态、IP地址、通信统计

## 优势特点

### 业务逻辑完整性
- ✅ 保持原始Main(2).ino的所有功能
- ✅ 编码器、按键、舵机、电机控制正常
- ✅ 数码管显示、EEPROM存储正常

### 无线通信可靠性
- ✅ 自动连接和重连机制
- ✅ 数据变化检测和同步
- ✅ 错误处理和超时保护
- ✅ JSON格式数据交换

### 系统扩展性
- ✅ 支持多子设备连接
- ✅ 可扩展更多数据类型
- ✅ 支持远程参数配置
- ✅ 支持状态监控和诊断
