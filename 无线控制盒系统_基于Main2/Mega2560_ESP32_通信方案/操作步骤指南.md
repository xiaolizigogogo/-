# ESP32-S3 + Mega2560 操作步骤指南

## 📁 文件说明

### 🎯 **主要使用的文件（按顺序）**

#### 1. **ESP32-S3 主控制器**
- **文件**：`ESP32-S3_实际引脚_主控制器.ino`
- **功能**：ESP32-S3主控制器代码
- **引脚**：TX0=1, RX0=3, D2=2, D12=12, D13=13

#### 2. **ESP32-S3 从控制器**
- **文件**：`ESP32-S3_实际引脚_从控制器.ino`
- **功能**：ESP32-S3从控制器代码
- **引脚**：TX0=1, RX0=3, D2=2, D5=5, D6=6, D13=13, A0=0

#### 3. **Mega2560 主控制器**
- **文件**：`Mega2560_主控制器.ino`
- **功能**：Mega2560主控制器代码

#### 4. **Mega2560 从控制器**
- **文件**：`Mega2560_从控制器.ino`
- **功能**：Mega2560从控制器代码

#### 5. **接线方案**
- **文件**：`ESP32-S3_实际引脚接线方案.md`
- **功能**：详细的接线说明

## 🔧 操作步骤

### 第一步：准备硬件

#### 需要的硬件
- ESP32-S3模块 × 2
- Arduino Mega2560 × 2
- 3.3V稳压模块 × 2
- 电平转换模块 × 2
- 继电器模块 × 1
- LED指示灯 × 1
- 电机驱动模块 × 1
- 传感器模块 × 1
- 连接线若干

### 第二步：硬件连接

#### 主控制器端连接
```
ESP32-S3模块    →    Mega2560
3.3V           →    3.3V
GND            →    GND
EN             →    3.3V (使能)
TX0 (GPIO1)    →    RX1 (引脚19)
RX0 (GPIO3)    →    TX1 (引脚18)
D2 (GPIO2)     →    数字引脚2 (状态指示)
D12 (GPIO12)   →    数字引脚3 (按钮输入)
D13 (GPIO13)   →    数字引脚4 (LED指示)
```

#### 从控制器端连接
```
ESP32-S3模块    →    Mega2560
3.3V           →    3.3V
GND            →    GND
EN             →    3.3V (使能)
TX0 (GPIO1)    →    RX1 (引脚19)
RX0 (GPIO3)    →    TX1 (引脚18)
D2 (GPIO2)     →    数字引脚2 (状态指示)

继电器模块     →    Mega2560
VCC            →    5V
GND            →    GND
IN             →    数字引脚4

LED指示灯      →    Mega2560
正极           →    数字引脚13
负极           →    GND

电机驱动       →    Mega2560
VCC            →    5V
GND            →    GND
PWM            →    数字引脚5

传感器         →    Mega2560
VCC            →    5V
GND            →    GND
OUT            →    模拟引脚A0
```

### 第三步：软件配置

#### 1. 安装Arduino IDE
- 下载并安装Arduino IDE 1.8.19或更高版本

#### 2. 安装ESP32开发板支持
1. 打开 **文件 → 首选项**
2. 在 **附加开发板管理器网址** 中添加：
   ```
   https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
   ```
3. 打开 **工具 → 开发板 → 开发板管理器**
4. 搜索并安装 **"ESP32 by Espressif Systems"**

#### 3. 安装所需库
打开 **工具 → 管理库**，搜索并安装：
- **ArduinoJson** (by Benoit Blanchon)

### 第四步：烧录代码

#### 1. 烧录ESP32-S3主控制器
1. 连接ESP32-S3到电脑
2. 选择开发板：**工具 → 开发板 → ESP32 Arduino → ESP32S3 Dev Module**
3. 选择端口：**工具 → 端口 → COMx**
4. 打开 `ESP32-S3_实际引脚_主控制器.ino`
5. 修改WiFi配置：
   ```cpp
   const char* ssid = "YourWiFiSSID";
   const char* password = "YourWiFiPassword";
   ```
6. 点击 **上传**

#### 2. 烧录ESP32-S3从控制器
1. 连接另一个ESP32-S3到电脑
2. 选择开发板：**工具 → 开发板 → ESP32 Arduino → ESP32S3 Dev Module**
3. 选择端口：**工具 → 端口 → COMx**
4. 打开 `ESP32-S3_实际引脚_从控制器.ino`
5. 修改WiFi配置：
   ```cpp
   const char* ssid = "YourWiFiSSID";
   const char* password = "YourWiFiPassword";
   ```
6. 点击 **上传**

#### 3. 烧录Mega2560主控制器
1. 连接Mega2560到电脑
2. 选择开发板：**工具 → 开发板 → Arduino AVR Boards → Arduino Mega or Mega 2560**
3. 选择端口：**工具 → 端口 → COMx**
4. 打开 `Mega2560_主控制器.ino`
5. 点击 **上传**

#### 4. 烧录Mega2560从控制器
1. 连接另一个Mega2560到电脑
2. 选择开发板：**工具 → 开发板 → Arduino AVR Boards → Arduino Mega or Mega 2560**
3. 选择端口：**工具 → 端口 → COMx**
4. 打开 `Mega2560_从控制器.ino`
5. 点击 **上传**

### 第五步：系统测试

#### 1. 上电启动
1. 按照接线方案连接所有硬件
2. 上电启动系统
3. 等待ESP32-S3模块连接WiFi
4. 观察串口监视器输出

#### 2. 功能测试
打开主控制器的串口监视器，输入以下命令：

##### 控制命令
```
control,relay,1    # 开启继电器
control,relay,0    # 关闭继电器
control,led,1      # 开启LED
control,led,0      # 关闭LED
control,motor,128  # 设置电机速度50%
control,sensor,0   # 读取传感器值
```

##### 状态查询
```
status             # 获取从控制器状态
test               # 测试连接
```

#### 3. 验证结果
- 检查从控制器是否响应命令
- 观察继电器、LED、电机是否正常工作
- 查看传感器数据是否正确
- 确认WiFi和蓝牙连接状态

## 🚨 常见问题解决

### 1. 烧录失败
**问题**：无法烧录程序到ESP32-S3
**解决方案**：
- 按住BOOT按钮，点击上传
- 降低上传速度到115200
- 检查USB线是否为数据线
- 尝试不同的USB端口

### 2. WiFi连接失败
**问题**：ESP32-S3无法连接WiFi
**解决方案**：
- 检查WiFi名称和密码
- 确认WiFi信号强度
- 检查WiFi频段设置
- 重启ESP32-S3模块

### 3. 串口通信异常
**问题**：Mega2560无法与ESP32-S3通信
**解决方案**：
- 检查接线是否正确
- 确认波特率设置为115200
- 检查电平转换电路
- 验证电源供应

### 4. 控制命令无响应
**问题**：发送控制命令后无响应
**解决方案**：
- 检查从控制器是否正常启动
- 确认ESP32-S3之间的通信是否正常
- 检查目标设备连接是否正确
- 查看串口监视器错误信息

## 📋 检查清单

### 硬件检查
- [ ] ESP32-S3模块连接正确
- [ ] Mega2560连接正确
- [ ] 电源供应稳定
- [ ] 接地连接良好
- [ ] 电平转换电路正常

### 软件检查
- [ ] Arduino IDE安装完成
- [ ] ESP32开发板支持安装
- [ ] ArduinoJson库安装
- [ ] WiFi配置正确
- [ ] 代码烧录成功

### 功能检查
- [ ] ESP32-S3启动正常
- [ ] WiFi连接成功
- [ ] 蓝牙连接成功
- [ ] 串口通信正常
- [ ] 控制命令响应
- [ ] 状态反馈正常

## 🎯 快速开始

### 最简单的测试方法
1. 只连接一个ESP32-S3和Mega2560
2. 烧录对应的代码
3. 打开串口监视器
4. 发送测试命令：`test`
5. 观察响应结果

### 完整系统测试
1. 连接两个ESP32-S3和两个Mega2560
2. 烧录所有代码
3. 配置WiFi网络
4. 发送控制命令测试
5. 验证双向通信

## 📞 技术支持

如遇到问题，请检查：
1. 硬件连接是否正确
2. 代码是否完整烧录
3. 串口监视器输出信息
4. 网络连接是否正常
5. 电源供应是否稳定

## 📝 总结

**主要使用的文件**：
1. `ESP32-S3_实际引脚_主控制器.ino`
2. `ESP32-S3_实际引脚_从控制器.ino`
3. `Mega2560_主控制器.ino`
4. `Mega2560_从控制器.ino`
5. `ESP32-S3_实际引脚接线方案.md`

**操作顺序**：
1. 准备硬件
2. 连接硬件
3. 配置软件
4. 烧录代码
5. 测试功能

按照这个指南操作，您就可以成功搭建ESP32-S3 + Mega2560通信系统了！
