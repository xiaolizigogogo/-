# Mega2560 + ESP32 通信系统使用说明

## 系统概述

本系统实现了两个Mega2560通过ESP32模块进行数据交互的完整解决方案。ESP32模块作为通信桥梁，支持WiFi和蓝牙两种通信方式。

## 系统架构

```
Mega2560主控制器 ←→ ESP32模块1 ←→ WiFi/蓝牙 ←→ ESP32模块2 ←→ Mega2560从控制器
```

## 硬件要求

### 主控制器端
- Arduino Mega2560 × 1
- ESP32-WROOM-32 模块 × 1
- 3.3V稳压模块 × 1
- 电平转换模块 × 1
- 连接线若干

### 从控制器端
- Arduino Mega2560 × 1
- ESP32-WROOM-32 模块 × 1
- 3.3V稳压模块 × 1
- 电平转换模块 × 1
- 继电器模块 × 1
- LED指示灯 × 1
- 电机驱动模块 × 1
- 传感器模块 × 1

## 接线方案

### ESP32模块引脚定义
- **VCC**: 3.3V电源
- **GND**: 地线
- **EN**: 使能引脚 (接3.3V)
- **GPIO0**: 启动模式选择 (悬空)
- **GPIO1**: TX (发送)
- **GPIO3**: RX (接收)
- **GPIO2**: 状态指示LED

### Mega2560主控制器接线
```
ESP32模块    →    Mega2560
VCC         →    3.3V
GND         →    GND
GPIO1(TX)   →    RX1 (引脚19)
GPIO3(RX)   →    TX1 (引脚18)
GPIO2       →    数字引脚2 (状态指示)
```

### Mega2560从控制器接线
```
ESP32模块    →    Mega2560
VCC         →    3.3V
GND         →    GND
GPIO1(TX)   →    RX1 (引脚19)
GPIO3(RX)   →    TX1 (引脚18)
GPIO2       →    数字引脚2 (状态指示)

继电器模块  →    Mega2560
VCC         →    5V
GND         →    GND
IN          →    数字引脚4

LED指示灯   →    Mega2560
正极        →    数字引脚13
负极        →    GND

电机驱动    →    Mega2560
VCC         →    5V
GND         →    GND
PWM         →    数字引脚5

传感器      →    Mega2560
VCC         →    5V
GND         →    GND
OUT         →    模拟引脚A0
```

## 软件配置

### 1. 安装Arduino IDE
- 下载并安装Arduino IDE 1.8.19或更高版本
- 或使用Arduino IDE 2.0

### 2. 安装ESP32开发板支持
1. 打开 **文件 → 首选项**
2. 在 **附加开发板管理器网址** 中添加：
   ```
   https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
   ```
3. 打开 **工具 → 开发板 → 开发板管理器**
4. 搜索并安装 **"ESP32 by Espressif Systems"**

### 3. 安装所需库
打开 **工具 → 管理库**，搜索并安装：
- **ArduinoJson** (by Benoit Blanchon)

### 4. 配置WiFi设置
在 `ESP32_通信模块.ino` 中修改WiFi配置：
```cpp
const char* ssid = "YourWiFiSSID";
const char* password = "YourWiFiPassword";
const char* serverIP = "192.168.1.100";  // 目标ESP32的IP地址
```

## 烧录步骤

### 1. 烧录Mega2560主控制器
1. 连接Mega2560到电脑
2. 选择开发板：**工具 → 开发板 → Arduino AVR Boards → Arduino Mega or Mega 2560**
3. 选择端口：**工具 → 端口 → COMx**
4. 打开 `Mega2560_主控制器.ino`
5. 点击 **上传**

### 2. 烧录Mega2560从控制器
1. 连接另一个Mega2560到电脑
2. 选择开发板：**工具 → 开发板 → Arduino AVR Boards → Arduino Mega or Mega 2560**
3. 选择端口：**工具 → 端口 → COMx**
4. 打开 `Mega2560_从控制器.ino`
5. 点击 **上传**

### 3. 烧录ESP32通信模块
1. 连接ESP32到电脑
2. 选择开发板：**工具 → 开发板 → ESP32 Arduino → ESP32 Dev Module**
3. 选择端口：**工具 → 端口 → COMx**
4. 打开 `ESP32_通信模块.ino`
5. 点击 **上传**

## 使用方法

### 1. 系统启动
1. 按照接线方案连接所有硬件
2. 上电启动系统
3. 等待ESP32模块连接WiFi
4. 观察串口监视器输出

### 2. 主控制器操作
打开主控制器的串口监视器，输入以下命令：

#### 控制命令
```
control,relay,1    # 开启继电器
control,relay,0    # 关闭继电器
control,led,1      # 开启LED
control,led,0      # 关闭LED
control,motor,128  # 设置电机速度50%
control,sensor,0   # 读取传感器值
```

#### 状态查询
```
status             # 获取从控制器状态
test               # 测试连接
```

### 3. 从控制器反馈
从控制器会自动响应主控制器的命令，并在串口监视器中显示：
- 控制执行结果
- 系统状态信息
- 传感器数据
- 错误信息

## 通信协议

### JSON消息格式

#### 控制命令
```json
{
  "type": "control",
  "target": "relay",
  "value": 1,
  "timestamp": 1234567890,
  "source": "master"
}
```

#### 状态响应
```json
{
  "type": "status_response",
  "system_ready": true,
  "execution_count": 15,
  "last_command": "relay",
  "sensor_value": 512,
  "uptime": 123456,
  "timestamp": 1234567890,
  "source": "slave"
}
```

#### 测试响应
```json
{
  "type": "test_response",
  "result": true,
  "timestamp": 1234567890,
  "source": "slave"
}
```

## 故障排除

### 1. ESP32无法连接WiFi
- 检查WiFi名称和密码是否正确
- 确认WiFi信号强度
- 检查ESP32模块是否正常

### 2. Mega2560无法与ESP32通信
- 检查串口接线是否正确
- 确认波特率设置为115200
- 检查电平转换模块是否工作正常

### 3. 控制命令无响应
- 检查从控制器是否正常启动
- 确认ESP32模块之间的通信是否正常
- 检查目标设备连接是否正确

### 4. 系统不稳定
- 检查电源供应是否稳定
- 确认所有连接是否牢固
- 检查是否有电磁干扰

## 扩展功能

### 1. 添加更多控制目标
在从控制器代码中添加新的控制逻辑：
```cpp
else if (target == "new_device") {
    // 添加新设备控制逻辑
    digitalWrite(NEW_DEVICE_PIN, value > 0 ? HIGH : LOW);
    success = true;
}
```

### 2. 添加更多传感器
在从控制器代码中添加传感器读取：
```cpp
else if (target == "new_sensor") {
    int sensorValue = analogRead(NEW_SENSOR_PIN);
    success = true;
    Serial.println("新传感器值: " + String(sensorValue));
}
```

### 3. 添加数据记录功能
可以添加SD卡模块记录控制历史和传感器数据。

## 技术支持

如遇到问题，请检查：
1. 硬件连接是否正确
2. 代码是否完整烧录
3. 串口监视器输出信息
4. 网络连接是否正常

## 版本信息

- 版本：1.0
- 更新日期：2024年
- 兼容性：Arduino Mega2560 + ESP32-WROOM-32
