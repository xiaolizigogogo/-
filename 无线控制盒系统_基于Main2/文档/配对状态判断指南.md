# 配对状态判断指南

## 概述

本指南将帮助您判断无线控制盒系统是否已成功配对，以及如何监控配对状态。

## 配对机制

### 1. 配对流程

#### 自动配对过程
1. **无线控制盒启动**：自动发送配对请求
2. **主控制器接收**：收到配对请求后发送确认
3. **配对完成**：两个设备建立连接
4. **状态同步**：开始数据同步和通信

#### 配对状态变量
```cpp
// 主控制器状态变量
bool wirelessConnected = false;  // 无线连接状态
unsigned long lastWirelessCommand = 0;  // 最后收到命令的时间

// 无线控制盒状态变量
bool wirelessConnected = false;  // 无线连接状态
bool isPaired = false;          // 配对状态
unsigned long lastWirelessCommand = 0;  // 最后收到命令的时间
```

## 判断配对状态的方法

### 1. 串口监视器查看

#### 主控制器串口输出
```
无线通信初始化完成
设备ID: 1
收到配对请求
配对确认已发送
状态数据已发送给无线控制盒
```

#### 无线控制盒串口输出
```
无线通信初始化完成
设备ID: 2
发送配对请求
配对成功！
收到无线命令: 0x01000001
```

### 2. 状态指示器

#### 主控制器状态指示
- **配对成功**：`Val.wirelessConnected = true`
- **配对失败**：`Val.wirelessConnected = false`

#### 无线控制盒状态指示
- **配对成功**：`Val.isPaired = true` 和 `Val.wirelessConnected = true`
- **配对失败**：`Val.isPaired = false` 或 `Val.wirelessConnected = false`

### 3. 功能测试

#### 测试方法1：按键操作测试
1. **主控制器操作**：
   - 按下任意按键
   - 观察无线控制盒是否有相应反应
   - 如果有反应，说明配对成功

2. **无线控制盒操作**：
   - 按下任意按键
   - 观察主控制器是否有相应反应
   - 如果有反应，说明配对成功

#### 测试方法2：编码器操作测试
1. **旋转编码器**：
   - 在主控制器上旋转编码器
   - 观察无线控制盒的显示是否同步更新
   - 如果同步，说明配对成功

2. **数据同步测试**：
   - 检查两个设备的显示是否一致
   - 如果一致，说明配对成功

## 配对状态监控

### 1. 实时状态监控

#### 主控制器监控代码
```cpp
// 在loop()函数中添加状态监控
void loop() {
  // ... 其他代码 ...
  
  // 监控配对状态
  static unsigned long lastStatusCheck = 0;
  unsigned long currentTime = millis();
  if (currentTime - lastStatusCheck >= 5000) {  // 每5秒检查一次
    if (Val.wirelessConnected) {
      Serial.println("配对状态：已连接");
    } else {
      Serial.println("配对状态：未连接");
    }
    lastStatusCheck = currentTime;
  }
}
```

#### 无线控制盒监控代码
```cpp
// 在loop()函数中添加状态监控
void loop() {
  // ... 其他代码 ...
  
  // 监控配对状态
  static unsigned long lastStatusCheck = 0;
  unsigned long currentTime = millis();
  if (currentTime - lastStatusCheck >= 5000) {  // 每5秒检查一次
    if (Val.isPaired && Val.wirelessConnected) {
      Serial.println("配对状态：已配对且已连接");
    } else if (Val.isPaired) {
      Serial.println("配对状态：已配对但未连接");
    } else {
      Serial.println("配对状态：未配对");
    }
    lastStatusCheck = currentTime;
  }
}
```

### 2. LED指示灯

#### 添加LED状态指示
```cpp
// 在主控制器中添加LED指示
void updatePairingLED() {
  if (Val.wirelessConnected) {
    digitalWrite(LED_BUILTIN, HIGH);  // 配对成功，LED常亮
  } else {
    digitalWrite(LED_BUILTIN, LOW);   // 配对失败，LED熄灭
  }
}

// 在无线控制盒中添加LED指示
void updatePairingLED() {
  if (Val.isPaired && Val.wirelessConnected) {
    digitalWrite(LED_BUILTIN, HIGH);  // 配对成功，LED常亮
  } else {
    digitalWrite(LED_BUILTIN, LOW);   // 配对失败，LED熄灭
  }
}
```

## 配对失败排查

### 1. 常见问题

#### 问题1：无法建立配对
**可能原因**：
- 433MHz模块连接错误
- 模块供电不稳定
- 设备距离过远
- 周围有干扰源

**解决方案**：
1. 检查模块连接是否正确
2. 确认电源电压是否稳定
3. 缩短设备距离
4. 避免干扰源

#### 问题2：配对后频繁断开
**可能原因**：
- 信号强度不足
- 电源不稳定
- 代码逻辑问题

**解决方案**：
1. 连接天线提高信号强度
2. 使用稳定的电源
3. 检查代码中的超时设置

### 2. 调试步骤

#### 步骤1：硬件检查
1. 检查433MHz模块连接
2. 确认电源电压（5V）
3. 检查天线连接
4. 确认设备距离（建议10米以内）

#### 步骤2：软件检查
1. 查看串口输出
2. 检查设备ID设置
3. 确认代码版本一致
4. 检查库是否正确安装

#### 步骤3：功能测试
1. 测试基本通信功能
2. 检查数据同步
3. 验证命令传输
4. 测试状态更新

## 配对状态代码示例

### 1. 主控制器配对状态检查

```cpp
// 在主控制器中添加配对状态检查函数
void checkPairingStatus() {
  static unsigned long lastCheck = 0;
  unsigned long currentTime = millis();
  
  if (currentTime - lastCheck >= 3000) {  // 每3秒检查一次
    if (Val.wirelessConnected) {
      Serial.println("✓ 配对状态：已连接");
      Serial.print("  最后通信时间：");
      Serial.print((currentTime - Val.lastWirelessCommand) / 1000);
      Serial.println("秒前");
    } else {
      Serial.println("✗ 配对状态：未连接");
      Serial.println("  等待无线控制盒配对...");
    }
    lastCheck = currentTime;
  }
}

// 在loop()函数中调用
void loop() {
  // ... 其他代码 ...
  checkPairingStatus();
}
```

### 2. 无线控制盒配对状态检查

```cpp
// 在无线控制盒中添加配对状态检查函数
void checkPairingStatus() {
  static unsigned long lastCheck = 0;
  unsigned long currentTime = millis();
  
  if (currentTime - lastCheck >= 3000) {  // 每3秒检查一次
    if (Val.isPaired && Val.wirelessConnected) {
      Serial.println("✓ 配对状态：已配对且已连接");
      Serial.print("  最后通信时间：");
      Serial.print((currentTime - Val.lastWirelessCommand) / 1000);
      Serial.println("秒前");
    } else if (Val.isPaired) {
      Serial.println("⚠ 配对状态：已配对但未连接");
      Serial.println("  尝试重新连接...");
    } else {
      Serial.println("✗ 配对状态：未配对");
      Serial.println("  正在尝试配对...");
    }
    lastCheck = currentTime;
  }
}

// 在loop()函数中调用
void loop() {
  // ... 其他代码 ...
  checkPairingStatus();
}
```

## 总结

### 配对成功的标志
1. **串口输出**：显示"配对成功！"
2. **状态变量**：`isPaired = true` 和 `wirelessConnected = true`
3. **功能测试**：两个设备可以相互通信
4. **数据同步**：编码器值和状态信息同步更新

### 配对失败的标志
1. **串口输出**：显示"无线连接超时，已断开"
2. **状态变量**：`isPaired = false` 或 `wirelessConnected = false`
3. **功能测试**：两个设备无法通信
4. **数据不同步**：编码器值和状态信息不同步

### 建议
1. **首次使用**：建议在10米以内进行配对
2. **稳定使用**：配对成功后可以适当增加距离
3. **定期检查**：建议定期检查配对状态
4. **故障排除**：遇到问题时按照调试步骤进行排查
