# 无线控制盒系统数据同步说明

## 系统概述

本系统实现了主控制器和无线控制盒之间的**完全数据同步**和**协同工作**功能。两个控制盒可以：

1. **实时数据同步**：编码器值、状态信息、参数设置等
2. **协同控制**：任一控制盒的操作都会影响另一个
3. **状态一致性**：两个控制盒显示相同的状态信息
4. **双向通信**：支持双向命令传输和数据交换

## 数据同步机制

### 1. 实时数据同步

#### 编码器数据同步
- **同步频率**：每100ms同步一次
- **同步内容**：
  - 编码器0：舵机角度控制
  - 编码器1：舵机速度控制
  - 编码器2：舵机时间控制
  - 编码器3：舵机中位控制
  - 编码器4：电机速度控制

#### 状态数据同步
- **同步频率**：状态变化时立即同步
- **同步内容**：
  - 电机开关状态
  - 舵机开关状态
  - 电机速度
  - 舵机速度
  - 系统运行状态

### 2. 命令传输机制

#### 主控制器 → 无线控制盒
```
命令类型          →    功能
CMD_STATUS       →    状态查询和更新
CMD_PAIR_REQUEST →    配对确认
0x20-0x24        →    编码器数据更新
0x30             →    心跳包
```

#### 无线控制盒 → 主控制器
```
命令类型          →    功能
CMD_RECORD       →    记录参数
CMD_SERVO_LEFT   →    舵机左转
CMD_SERVO_RIGHT  →    舵机右转
CMD_MOTOR_FWD    →    电机前进
CMD_MOTOR_STOP   →    电机停止
CMD_PAIR_REQUEST →    配对请求
```

## 协同工作模式

### 1. 主控制器模式

#### 功能特点
- **主控制权**：拥有最终控制权
- **数据源**：作为主要数据源
- **状态管理**：管理整体系统状态
- **参数存储**：负责参数持久化存储

#### 工作流程
1. 接收无线控制盒的命令
2. 处理命令并更新系统状态
3. 将状态变化同步给无线控制盒
4. 执行相应的硬件控制操作

### 2. 无线控制盒模式

#### 功能特点
- **远程控制**：可以远程控制主控制器
- **状态显示**：显示与主控制器相同的状态
- **参数同步**：实时同步主控制器的参数
- **本地操作**：支持本地编码器操作

#### 工作流程
1. 发送命令给主控制器
2. 接收主控制器的状态更新
3. 更新本地显示和状态
4. 同步编码器数据

## 数据同步详细说明

### 1. 编码器数据同步

#### 同步机制
```cpp
// 主控制器发送编码器数据
void sendEncoderValuesToWireless() {
  // 发送编码器0的值（舵机角度）
  uint32_t encoder0Data = (DEVICE_ID_2 << 16) | 0x20 | (ecCnt[0] & 0xFF);
  mySwitch.send(encoder0Data, 24);
  
  // 发送编码器1的值（舵机速度）
  uint32_t encoder1Data = (DEVICE_ID_2 << 16) | 0x21 | (ecCnt[1] & 0xFF);
  mySwitch.send(encoder1Data, 24);
  
  // 发送编码器2的值（舵机时间）
  uint32_t encoder2Data = (DEVICE_ID_2 << 16) | 0x22 | (ecCnt[2] & 0xFF);
  mySwitch.send(encoder2Data, 24);
  
  // 发送编码器3的值（舵机中位）
  uint32_t encoder3Data = (DEVICE_ID_2 << 16) | 0x23 | (ecCnt[3] & 0xFF);
  mySwitch.send(encoder3Data, 24);
  
  // 发送编码器4的值（电机速度）
  uint32_t encoder4Data = (DEVICE_ID_2 << 16) | 0x24 | (ecCnt[4] & 0xFF);
  mySwitch.send(encoder4Data, 24);
}
```

#### 接收处理
```cpp
// 无线控制盒接收编码器数据
case 0x20: // 编码器0数据
  ecCnt[0] = command & 0xFF;
  break;
case 0x21: // 编码器1数据
  ecCnt[1] = command & 0xFF;
  break;
case 0x22: // 编码器2数据
  ecCnt[2] = command & 0xFF;
  break;
case 0x23: // 编码器3数据
  ecCnt[3] = command & 0xFF;
  break;
case 0x24: // 编码器4数据
  ecCnt[4] = command & 0xFF;
  break;
```

### 2. 状态数据同步

#### 状态发送
```cpp
// 主控制器发送状态数据
void sendStatusToWireless() {
  // 构建状态数据
  uint32_t statusData = (DEVICE_ID_2 << 16) | CMD_STATUS;
  statusData |= (Val.motorSw ? 0x01 : 0x00) << 8;
  statusData |= (Val.steerSw ? 0x01 : 0x00) << 9;
  statusData |= (Val.motorSpeed & 0xFF) << 10;
  statusData |= (Val.steerSpeed & 0xFF) << 18;
  
  mySwitch.send(statusData, 24);
}
```

#### 状态接收
```cpp
// 无线控制盒接收状态数据
void updateStatusFromMaster(uint32_t statusData) {
  Val.motorSw = (statusData >> 8) & 0x01;
  Val.steerSw = (statusData >> 9) & 0x01;
  Val.motorSpeed = (statusData >> 10) & 0xFF;
  Val.steerSpeed = (statusData >> 18) & 0xFF;
}
```

## 协同工作场景

### 1. 正常协同工作

#### 场景描述
- 主控制器和无线控制盒都已启动
- 两个设备已成功配对
- 无线连接稳定

#### 工作流程
1. **初始化**：两个设备启动并自动配对
2. **数据同步**：编码器数据和状态信息实时同步
3. **协同控制**：任一设备操作都会影响另一个
4. **状态显示**：两个设备显示相同的状态信息

### 2. 主控制器操作

#### 操作流程
1. 用户在主控制器上操作编码器或按键
2. 主控制器更新本地状态
3. 主控制器发送状态更新给无线控制盒
4. 无线控制盒接收并更新本地状态
5. 两个设备显示相同的状态

### 3. 无线控制盒操作

#### 操作流程
1. 用户在无线控制盒上操作编码器或按键
2. 无线控制盒发送命令给主控制器
3. 主控制器接收并处理命令
4. 主控制器更新系统状态
5. 主控制器发送状态更新给无线控制盒
6. 两个设备显示相同的状态

## 数据一致性保证

### 1. 实时同步机制

#### 同步频率
- **编码器数据**：每100ms同步一次
- **状态数据**：状态变化时立即同步
- **心跳包**：每5秒发送一次

#### 同步策略
- **增量同步**：只同步变化的数据
- **全量同步**：定期进行全量数据同步
- **冲突解决**：主控制器拥有最终决定权

### 2. 数据验证机制

#### 数据校验
- **命令格式**：验证命令格式的正确性
- **数据范围**：验证数据是否在有效范围内
- **设备ID**：验证命令是否针对正确的设备

#### 错误处理
- **重传机制**：重要数据丢失时自动重传
- **超时处理**：连接超时时自动重连
- **降级模式**：无线连接失败时降级为本地模式

## 系统优势

### 1. 数据同步优势

#### 实时性
- **毫秒级同步**：数据变化毫秒级同步
- **低延迟**：无线通信延迟小于10ms
- **高频率**：支持高频数据同步

#### 一致性
- **状态一致**：两个设备状态完全一致
- **显示一致**：两个设备显示相同信息
- **操作一致**：任一设备操作都会影响另一个

### 2. 协同工作优势

#### 灵活性
- **远程控制**：支持远程控制操作
- **本地操作**：支持本地直接操作
- **混合模式**：支持远程和本地混合操作

#### 可靠性
- **冗余设计**：两个设备互为备份
- **故障恢复**：单个设备故障不影响整体功能
- **自动重连**：连接断开时自动重连

## 使用建议

### 1. 最佳实践

#### 操作建议
- **主控制器优先**：重要操作建议在主控制器进行
- **状态确认**：操作前确认两个设备状态一致
- **定期检查**：定期检查无线连接状态

#### 维护建议
- **定期测试**：定期测试数据同步功能
- **固件更新**：及时更新固件版本
- **参数备份**：定期备份重要参数

### 2. 故障排除

#### 常见问题
- **数据不同步**：检查无线连接状态
- **操作无响应**：检查设备配对状态
- **显示异常**：检查数据同步是否正常

#### 解决方案
- **重启设备**：重启两个设备重新配对
- **检查连接**：检查433MHz模块连接
- **重置参数**：必要时重置系统参数
