# ESP32 + Mega 2560 通信协议说明

## 系统架构

```
[Web浏览器/手机] ←→ [WiFi] ←→ [ESP32主控制器] ←→ [串口通信] ←→ [Mega 2560从控制器] ←→ [硬件设备]
```

## 通信协议

### 1. ESP32 → Mega 2560 命令格式

#### 电机控制命令
```
MOTOR_1_ON          # 开启电机1
MOTOR_1_OFF         # 关闭电机1
MOTOR_1_SPEED_128   # 设置电机1速度为128 (0-255)
MOTOR_2_ON          # 开启电机2
MOTOR_2_OFF         # 关闭电机2
MOTOR_2_SPEED_200   # 设置电机2速度为200 (0-255)
```

#### LED控制命令
```
LED_ON              # 开启LED
LED_OFF             # 关闭LED
```

#### 系统控制命令
```
EMERGENCY_STOP      # 紧急停止所有设备
RESET               # 重置系统
INIT                # 初始化请求
HEARTBEAT           # 心跳检测
```

### 2. Mega 2560 → ESP32 响应格式

#### 状态报告
```
STATUS:TEMP:25:HUM:60:MOTOR1:ON:SPEED1:128:MOTOR2:OFF:SPEED2:0:LED:ON
```

字段说明：
- `TEMP:25` - 温度25°C
- `HUM:60` - 湿度60%
- `MOTOR1:ON` - 电机1状态（ON/OFF）
- `SPEED1:128` - 电机1速度（0-255）
- `MOTOR2:OFF` - 电机2状态（ON/OFF）
- `SPEED2:0` - 电机2速度（0-255）
- `LED:ON` - LED状态（ON/OFF）

#### 系统响应
```
INIT_OK                    # 初始化完成
HEARTBEAT                  # 心跳响应
HEARTBEAT_OK              # 心跳确认
EMERGENCY_STOP_ACTIVATED  # 紧急停止已激活
SYSTEM_RESET              # 系统已重置
```

### 3. Web API 接口

#### 获取设备状态
```
GET /api/status
```

响应示例：
```json
{
  "connected": true,
  "deviceName": "Mega2560_Device",
  "temperature": 25,
  "humidity": 60,
  "motor1_enabled": true,
  "motor1_speed": 128,
  "motor2_enabled": false,
  "motor2_speed": 0,
  "led_status": true
}
```

#### 电机控制
```
POST /api/motor
Content-Type: application/json

{
  "motor": 1,
  "action": "on",
  "speed": 128
}
```

参数说明：
- `motor`: 电机编号（1或2）
- `action`: 动作（"on", "off"）
- `speed`: 速度（0-255，可选）

#### LED控制
```
POST /api/led
Content-Type: application/json

{
  "action": "toggle"
}
```

#### 系统控制
```
POST /api/control
Content-Type: application/json

{
  "action": "emergency_stop"
}
```

支持的动作：
- `emergency_stop` - 紧急停止
- `reset` - 重置系统

## 通信时序

### 1. 初始化流程
```
ESP32启动 → 连接WiFi → 启动Web服务器 → 发送INIT命令 → Mega2560响应INIT_OK
```

### 2. 心跳机制
```
ESP32每5秒发送HEARTBEAT → Mega2560响应HEARTBEAT → 更新连接状态
```

### 3. 状态同步
```
Mega2560每2秒发送STATUS → ESP32解析状态 → 更新Web界面显示
```

### 4. 控制流程
```
Web界面操作 → ESP32接收命令 → 解析并发送到Mega2560 → Mega2560执行 → 返回状态确认
```

## 错误处理

### 1. 连接超时
- ESP32超过10秒未收到Mega2560心跳，标记为断开连接
- Web界面显示设备离线状态

### 2. 命令错误
- 无效命令被忽略
- 错误参数被约束到有效范围

### 3. 紧急停止
- 任何时刻都可以触发紧急停止
- 紧急停止后需要手动重置系统

## 数据格式规范

### 1. 字符串格式
- 所有命令和响应都是字符串格式
- 使用冒号(:)作为字段分隔符
- 使用换行符(\n)作为消息结束符

### 2. 数值范围
- 电机速度：0-255
- 温度：-10到50°C
- 湿度：0-100%

### 3. 状态值
- 布尔状态：ON/OFF
- 连接状态：true/false

## 扩展性

### 1. 添加新设备
- 在Mega2560代码中添加新的控制函数
- 在ESP32代码中添加对应的API接口
- 更新Web界面的控制元素

### 2. 添加新传感器
- 在Mega2560中添加传感器读取代码
- 在STATUS消息中添加新的数据字段
- 在Web界面中显示新的传感器数据

### 3. 多设备支持
- 可以扩展为支持多个Mega2560设备
- 使用设备ID区分不同的从控制器
- 实现设备发现和自动配置功能





