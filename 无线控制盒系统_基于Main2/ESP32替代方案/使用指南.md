# ESP32 + Mega 2560 无线控制系统使用指南

## 系统简介

本系统使用ESP32作为主控制器，通过WiFi提供Web界面控制，通过串口与Mega 2560通信，实现远程控制电机、LED等设备的功能。相比nRF24L01方案，具有以下优势：

- **更稳定的通信**：WiFi比nRF24L01更稳定可靠
- **更远的控制距离**：WiFi覆盖范围更大
- **更丰富的功能**：支持Web界面、移动端控制
- **更简单的配置**：无需复杂的射频配置
- **更好的扩展性**：易于添加新功能

## 快速开始

### 1. 硬件准备

按照《接线指南.md》完成硬件连接：
- ESP32与Mega 2560串口连接
- 电机驱动模块连接
- 传感器连接
- 电源连接

### 2. 软件配置

#### ESP32配置
1. 打开Arduino IDE
2. 安装ESP32开发板支持包
3. 打开`ESP32_Master_Controller.ino`
4. 修改WiFi配置：
   ```cpp
   const char* ssid = "YourWiFiSSID";        // 修改为您的WiFi名称
   const char* password = "YourWiFiPassword"; // 修改为您的WiFi密码
   ```
5. 上传代码到ESP32

#### Mega 2560配置
1. 打开Arduino IDE
2. 选择Arduino Mega 2560开发板
3. 打开`Mega2560_Slave_Controller.ino`
4. 上传代码到Mega 2560

### 3. 系统启动

1. 给ESP32和Mega 2560上电
2. 等待ESP32连接WiFi（约10-30秒）
3. 在串口监视器中查看ESP32的IP地址
4. 在浏览器中访问该IP地址

## 功能使用

### 1. Web界面控制

#### 设备状态监控
- **连接状态**：显示Mega 2560是否在线
- **温度显示**：实时显示温度传感器读数
- **湿度显示**：实时显示湿度传感器读数

#### 电机控制
- **电机开关**：点击"开启"/"关闭"按钮控制电机
- **速度调节**：拖动滑块调节电机速度（0-255）
- **实时反馈**：界面实时显示电机状态和速度

#### LED控制
- **LED切换**：点击"切换LED"按钮控制LED开关
- **状态显示**：实时显示LED当前状态

#### 系统控制
- **紧急停止**：立即停止所有设备运行
- **系统重置**：重置所有设备到初始状态

### 2. 移动端控制

系统支持手机浏览器访问，界面自适应移动设备：
- 触摸友好的按钮设计
- 响应式布局
- 实时状态更新

### 3. API接口使用

系统提供RESTful API接口，支持第三方应用集成：

#### 获取设备状态
```bash
curl http://ESP32_IP/api/status
```

#### 控制电机
```bash
curl -X POST http://ESP32_IP/api/motor \
  -H "Content-Type: application/json" \
  -d '{"motor": 1, "action": "on", "speed": 128}'
```

#### 控制LED
```bash
curl -X POST http://ESP32_IP/api/led \
  -H "Content-Type: application/json" \
  -d '{"action": "toggle"}'
```

## 高级配置

### 1. WiFi配置

#### 修改WiFi设置
在ESP32代码中修改WiFi配置：
```cpp
const char* ssid = "YourWiFiSSID";
const char* password = "YourWiFiPassword";
```

#### AP模式
如果WiFi连接失败，ESP32会自动进入AP模式：
- SSID：ESP32_Controller
- 密码：12345678
- 访问地址：192.168.4.1

### 2. 通信参数调整

#### 串口波特率
默认波特率：9600
如需修改，同时修改ESP32和Mega 2560代码中的波特率设置。

#### 心跳间隔
- ESP32发送心跳：5秒
- Mega 2560发送状态：2秒
- 连接超时：10秒

### 3. 硬件参数调整

#### 电机控制
在Mega 2560代码中修改电机控制引脚：
```cpp
const int MOTOR1_ENABLE = 2;  // 修改为实际使用的引脚
const int MOTOR1_IN1 = 3;
// ... 其他引脚
```

#### 传感器配置
根据实际使用的传感器修改读取代码：
```cpp
// 温度传感器读取
int tempRaw = analogRead(TEMP_SENSOR_PIN);
systemState.temperature = map(tempRaw, 0, 1023, -10, 50);
```

## 故障排除

### 1. 常见问题

#### ESP32无法连接WiFi
- 检查WiFi名称和密码是否正确
- 确认WiFi信号强度
- 重启ESP32

#### Mega 2560无响应
- 检查串口连接
- 确认波特率设置
- 检查共地连接

#### 电机不转
- 检查电机驱动模块电源
- 确认PWM信号输出
- 检查电机连接

#### 传感器读数异常
- 检查传感器电源
- 确认模拟引脚连接
- 检查传感器是否损坏

### 2. 调试方法

#### 串口调试
- ESP32串口监视器：查看WiFi连接状态和Web请求
- Mega 2560串口监视器：查看命令接收和执行状态

#### 网络调试
- 使用ping命令测试ESP32网络连接
- 使用浏览器开发者工具查看API请求

#### 硬件调试
- 使用万用表检查电源电压
- 使用示波器检查PWM信号
- 使用逻辑分析仪检查串口通信

### 3. 错误代码

#### 连接错误
- `连接超时`：Mega 2560无响应，检查串口连接
- `WiFi连接失败`：检查WiFi配置和信号强度

#### 控制错误
- `电机控制失败`：检查电机驱动模块和连接
- `传感器读取失败`：检查传感器连接和电源

## 安全注意事项

### 1. 电气安全
- 确保所有设备正确接地
- 使用合适的电源容量
- 避免短路和过载

### 2. 机械安全
- 电机安装牢固
- 避免电机堵转
- 提供紧急停止功能

### 3. 网络安全
- 修改默认WiFi密码
- 使用强密码
- 定期更新固件

## 扩展开发

### 1. 添加新设备
1. 在Mega 2560代码中添加设备控制函数
2. 在ESP32代码中添加对应的API接口
3. 在Web界面中添加控制元素

### 2. 添加新传感器
1. 在Mega 2560中添加传感器读取代码
2. 在STATUS消息中添加新的数据字段
3. 在Web界面中显示新的传感器数据

### 3. 多设备支持
1. 使用设备ID区分不同的从控制器
2. 实现设备发现和自动配置功能
3. 添加设备管理界面

## 技术支持

### 1. 文档资源
- 《接线指南.md》：详细的硬件连接说明
- 《通信协议说明.md》：完整的通信协议文档
- 代码注释：详细的代码说明

### 2. 调试工具
- 串口监视器：实时查看系统状态
- Web界面：直观的设备控制界面
- API接口：程序化控制系统

### 3. 常见问题
- 参考故障排除章节
- 检查硬件连接
- 验证软件配置

## 版本更新

### 当前版本：v1.0
- 基础电机控制功能
- Web界面控制
- 传感器数据读取
- 紧急停止功能

### 计划功能
- 数据记录和存储
- 远程固件更新
- 多设备管理
- 安全认证机制



