# Main_Wireless 使用指南

## 概述
基于 Main(2).ino 业务逻辑的无线数据同步系统，实现主设备向子设备的 EEPROM 数据同步。

## 文件说明

### 完整版本
1. **`Main_Wireless_Master_完整版.ino`** - 主设备完整版
   - 包含完整的业务逻辑（编码器、按键、舵机、电机控制）
   - WiFi AP模式，创建热点
   - 定时向子设备同步EEPROM数据

2. **`Main_Wireless_Slave_完整版.ino`** - 子设备完整版
   - WiFi Station模式，连接主设备热点
   - 接收系统参数数据
   - 保存数据到本地EEPROM

### 测试版本
3. **`Main_Wireless_测试版本.ino`** - 简化测试版
   - 不包含硬件控制逻辑
   - 专注于通信功能测试
   - 通过修改 `DEVICE_ROLE` 选择设备角色

## 快速开始

### 方法1：使用测试版本（推荐新手）

#### 步骤1：准备测试环境
1. 准备两个 ESP32 开发板
2. 确保安装了 ArduinoJson 库

#### 步骤2：配置主设备
1. 打开 `Main_Wireless_测试版本.ino`
2. 确保 `#define DEVICE_ROLE 1`（主设备）
3. 上传到第一个 ESP32

#### 步骤3：配置子设备
1. 修改 `#define DEVICE_ROLE 2`（子设备）
2. 上传到第二个 ESP32

#### 步骤4：测试通信
1. 先启动主设备，观察串口输出
2. 再启动子设备，观察连接状态
3. 验证数据同步功能

### 方法2：使用完整版本（生产环境）

#### 步骤1：部署主设备
1. 上传 `Main_Wireless_Master_完整版.ino` 到主设备
2. 连接所有硬件（编码器、按键、舵机、电机、数码管）
3. 启动设备，确认业务逻辑正常

#### 步骤2：部署子设备
1. 上传 `Main_Wireless_Slave_完整版.ino` 到子设备
2. 启动设备，确认连接成功

## 网络配置

### 默认设置
- **热点名称**: `MainController`
- **热点密码**: `12345678`
- **主设备IP**: `192.168.4.1`
- **子设备IP**: `192.168.4.2`
- **UDP端口**: `1234`

### 自定义配置
可以修改程序中的网络参数：
```cpp
const char* ap_ssid = "你的热点名称";
const char* ap_password = "你的密码";
const int udp_port = 1234;
```

## 数据同步机制

### 同步触发条件
1. **数据变化时**: 编码器、按键操作后立即同步
2. **定时同步**: 每2秒检查一次数据变化
3. **请求同步**: 子设备每5秒请求一次数据

### 同步数据类型
- 舵机参数（角度、速度、时间）
- 电机参数（速度、开关状态）
- 编码器数据（5个编码器值）
- 系统状态（开关标志、模式标志）

## 监控和调试

### 主设备监控要点
```
✓ 热点创建成功
✓ 业务逻辑正常运行
✓ 数据变化检测正常
✓ 数据发送成功
✓ 子设备确认收到
```

### 子设备监控要点
```
✓ 连接主设备成功
✓ 接收数据正常
✓ JSON解析成功
✓ EEPROM保存成功
✓ 数据验证通过
```

### 串口输出示例

**主设备输出：**
```
==========================================
主设备启动 - 业务逻辑 + 无线通信
==========================================
热点名称: MainController
热点密码: 12345678
AP IP地址: 192.168.4.1
UDP端口: 1234
等待子设备连接...
==========================================
系统初始化完成！
发送数据到子设备: {"type":"SYSTEM_DATA","timestamp":12345,...}
```

**子设备输出：**
```
==========================================
子设备启动 - 数据同步接收器
==========================================
正在连接主设备热点: MainController
✓ 连接主设备成功！
本机IP地址: 192.168.4.2
主设备IP: 192.168.4.1
UDP端口: 1234
==========================================
收到数据: {"type":"SYSTEM_DATA",...}
=== 接收到的系统数据 ===
舵机角度: 150
舵机速度: 25
...
数据已保存到EEPROM
```

## 故障排除

### 问题1：子设备连接失败
**症状**: 子设备显示"连接失败"
**解决方案**:
1. 确认主设备已启动并创建热点
2. 检查热点名称和密码是否正确
3. 重启两个设备

### 问题2：数据同步失败
**症状**: 子设备无法接收数据
**解决方案**:
1. 检查UDP端口是否一致
2. 确认IP地址配置正确
3. 检查JSON数据格式

### 问题3：EEPROM保存失败
**症状**: 数据无法保存到EEPROM
**解决方案**:
1. 检查EEPROM地址映射
2. 确认数据格式正确
3. 验证EEPROM写入权限

### 问题4：业务逻辑异常
**症状**: 硬件控制不正常
**解决方案**:
1. 检查硬件连接
2. 确认引脚定义正确
3. 验证中断处理函数

## 扩展功能

### 多子设备支持
可以扩展支持多个子设备：
```cpp
IPAddress slave_ips[] = {
  IPAddress(192, 168, 4, 2),
  IPAddress(192, 168, 4, 3),
  IPAddress(192, 168, 4, 4)
};
```

### 远程控制
可以添加远程控制功能：
```cpp
// 接收远程控制命令
if (receivedData.startsWith("REMOTE_")) {
  handleRemoteCommand(receivedData);
}
```

### 状态监控
可以添加状态监控功能：
```cpp
// 发送系统状态
void sendSystemStatus() {
  // 发送CPU温度、内存使用等信息
}
```

## 性能优化

### 数据压缩
对于大量数据，可以使用数据压缩：
```cpp
// 压缩JSON数据
String compressedData = compressJson(jsonString);
```

### 批量传输
对于多个参数，可以批量传输：
```cpp
// 批量发送多个参数
void sendBatchData() {
  // 一次发送多个参数
}
```

### 缓存机制
可以添加数据缓存机制：
```cpp
// 缓存未发送的数据
void cacheData() {
  // 缓存数据，批量发送
}
```

## 总结

Main_Wireless 系统成功实现了：
- ✅ 保持原始业务逻辑完整性
- ✅ 无线数据同步功能
- ✅ 可靠的通信协议
- ✅ 完整的错误处理
- ✅ 易于扩展的架构

通过这个系统，主设备的所有参数变化都会自动同步到子设备，实现了真正的无线数据同步。
