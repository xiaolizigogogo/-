# 双设备配置指南

## 🎯 系统架构

```
设备1: Mega2560主设备 ←→ ESP32主设备 ←→ WiFi/UDP ←→ ESP32从设备 ←→ Mega2560从设备
```

## 📋 配置步骤

### 步骤1: 准备硬件

#### 设备1 (主设备)
- Mega2560 + ESP32
- 连接方式：
  ```
  Mega2560主设备    ESP32主设备
  ──────────────    ──────────
  TX2 (Pin 16)  →   RX (Pin 3)
  RX2 (Pin 17)  ←   TX (Pin 1)
  GND           →   GND
  5V            →   VIN
  ```

#### 设备2 (从设备)
- Mega2560 + ESP32
- 连接方式：
  ```
  Mega2560从设备    ESP32从设备
  ──────────────    ──────────
  TX2 (Pin 16)  →   RX (Pin 3)
  RX2 (Pin 17)  ←   TX (Pin 1)
  GND           →   GND
  5V            →   VIN
  ```

### 步骤2: 配置WiFi网络

#### 2.1 确保WiFi网络可用
- 确保两个设备都能连接到同一个WiFi网络
- 记录WiFi名称和密码

#### 2.2 分配IP地址
- 设备1 (主设备): 192.168.1.101
- 设备2 (从设备): 192.168.1.102

### 步骤3: 上传程序

#### 3.1 设备1 (主设备)
1. **Mega2560**: 上传 `Mega2560_ESP32_主设备_完整版.ino`
2. **ESP32**: 上传 `ESP32_通信桥接模块_主设备.ino`

#### 3.2 设备2 (从设备)
1. **Mega2560**: 上传 `Mega2560_ESP32_从设备_完整版.ino`
2. **ESP32**: 上传 `ESP32_通信桥接模块.ino`

### 步骤4: 修改WiFi配置

#### 4.1 修改主设备ESP32配置
在 `ESP32_通信桥接模块_主设备.ino` 中：
```cpp
const char* ssid = "YourWiFiSSID";        // 修改为你的WiFi名称
const char* password = "YourWiFiPassword"; // 修改为你的WiFi密码
IPAddress target_ip(192, 168, 1, 102);    // 从设备IP
```

#### 4.2 修改从设备ESP32配置
在 `ESP32_通信桥接模块.ino` 中：
```cpp
const char* ssid = "YourWiFiSSID";        // 修改为你的WiFi名称
const char* password = "YourWiFiPassword"; // 修改为你的WiFi密码
IPAddress target_ip(192, 168, 1, 101);    // 主设备IP
```

## 🔧 测试步骤

### 1. 单设备测试
1. 先测试设备1，确保Mega2560与ESP32通信正常
2. 再测试设备2，确保Mega2560与ESP32通信正常

### 2. 双设备测试
1. 同时启动两个设备
2. 观察串口输出，确认WiFi连接成功
3. 测试数据同步功能

### 3. 功能测试
- **编码器旋转**: 观察数据是否实时同步
- **按键操作**: 观察状态变化是否同步
- **舵机控制**: 观察舵机是否同步运动

## 📊 预期输出

### 主设备串口输出
```
ESP32 通信桥接模块启动 - 主设备
WiFi连接成功！
IP地址: 192.168.1.101
Mega2560连接成功！
收到Mega2560数据: MASTER_DATA:106.00,4,23,3,0,1202,35,1,0,0,0,70,17,31,102,1
发送UDP数据: MASTER_DATA:106.00,4,23,3,0,1202,35,1,0,0,0,70,17,31,102,1
```

### 从设备串口输出
```
ESP32 通信桥接模块启动
WiFi连接成功！
IP地址: 192.168.1.102
Mega2560连接成功！
收到UDP数据: MASTER_DATA:106.00,4,23,3,0,1202,35,1,0,0,0,70,17,31,102,1
转发给本地Mega2560: MASTER_DATA:106.00,4,23,3,0,1202,35,1,0,0,0,70,17,31,102,1
```

## 🚨 故障排除

### 1. WiFi连接失败
- 检查WiFi名称和密码是否正确
- 确保WiFi网络可用
- 检查信号强度

### 2. Mega2560连接超时
- 检查接线是否正确
- 确保串口波特率一致 (115200)
- 检查电源供应

### 3. UDP通信失败
- 检查IP地址配置
- 确保防火墙没有阻止UDP端口1234
- 检查网络连接

### 4. 数据同步异常
- 检查数据格式是否正确
- 确保JSON解析正常
- 检查EEPROM读写权限

## 📝 注意事项

1. **电源供应**: 确保ESP32有足够的电源供应
2. **接地**: 确保所有设备共地
3. **串口冲突**: 避免串口监控器冲突
4. **网络稳定**: 确保WiFi网络稳定
5. **IP地址**: 确保IP地址不冲突

## 🎉 成功标志

当看到以下输出时，表示系统配置成功：
- 两个设备都显示"WiFi连接成功！"
- 两个设备都显示"Mega2560连接成功！"
- 数据能够正常同步
- 心跳保持正常
