# 多电机舵机控制系统说明文档

## 1. 系统概述

### 1.1 系统简介
本系统是一个基于Arduino的多电机舵机控制系统，具备参数调节、实时显示、数据存储等功能。系统通过旋转编码器进行参数调节，通过按键进行功能切换，通过数码管显示当前参数状态。

### 1.2 主要特性
- **多执行器控制**：支持1个舵机和3个电机的独立控制
- **实时参数调节**：7个旋转编码器提供实时参数调节
- **参数持久化**：支持参数保存到EEPROM，断电后自动恢复
- **直观显示**：3组数码管实时显示关键参数
- **灵活控制**：支持多种控制模式和参数组合

## 2. 硬件配置

### 2.1 核心控制器
- **主控板**：Arduino Mega 2560（推荐）或兼容板型
- **工作电压**：5V
- **通信接口**：USB串口

### 2.2 执行器配置

#### 舵机系统
- **舵机型号**：标准舵机（支持PWM控制）
- **控制引脚**：Pin 9
- **角度范围**：0° - 180°
- **脉冲范围**：1100μs - 2000μs
- **中位点**：1550μs

#### 电机系统
- **电机数量**：3个独立电机
- **控制方式**：PWM + 方向控制
- **PWM引脚**：Pin 7, 8, 10
- **方向控制引脚**：Pin 4, 5, 6
- **PWM频率**：500Hz

### 2.3 输入设备

#### 旋转编码器（7个）
| 编码器 | CLK引脚 | DT引脚 | 功能描述 |
|--------|---------|--------|----------|
| 编码器0 | Pin 2 | Pin 11 | 舵机摆动幅度调节 |
| 编码器1 | Pin 3 | Pin 12 | 舵机摆动速度调节 |
| 编码器2 | Pin 21 | Pin 13 | 舵机停留时间调节 |
| 编码器3 | Pin 20 | Pin 14 | 舵机中位点调节 |
| 编码器4 | Pin 19 | Pin 15 | 电机1速度调节 |
| 编码器5 | Pin 18 | Pin 16 | 电机2速度调节 |
| 编码器6 | Pin 23 | Pin 17 | 电机3速度调节 |

#### 按键（7个）
| 按键 | 引脚 | 功能描述 |
|------|------|----------|
| 按键1 | Pin 31 | 参数保存 |
| 按键2 | Pin 33 | 舵机开关 |
| 按键3 | Pin 35 | 停留时间模式切换 |
| 按键4 | Pin 37 | 舵机开关（备用） |
| 按键5 | Pin 39 | 电机1开关 |
| 按键6 | Pin 41 | 电机2开关 |
| 按键7 | Pin 43 | 电机3开关 |

### 2.4 显示设备

#### 数码管显示（3组）
- **显示芯片**：74HC595移位寄存器
- **数码管1**：Pin 36, 34, 32 - 显示左右停留时间
- **数码管2**：Pin 26, 24, 22 - 显示摆动幅度和速度
- **数码管3**：Pin 46, 44, 42 - 显示电机速度

## 3. 系统参数

### 3.1 舵机参数
- **摆动角度范围**：0° - 180°
- **摆动速度范围**：0 - 99（数值越大速度越慢）
- **停留时间范围**：0 - 25秒
- **中位点范围**：1100μs - 2000μs

### 3.2 电机参数
- **速度范围**：0 - 99
- **控制模式**：正转/停止
- **PWM分辨率**：8位（0-255）

### 3.3 系统参数
- **控制周期**：32ms
- **按键消抖时间**：20ms
- **长按时间**：1000ms
- **EEPROM存储大小**：4096字节

## 4. 工作原理

### 4.1 舵机控制逻辑
1. **状态机控制**：系统采用4状态状态机控制舵机运动
   - LEFT_STOP：左端停留
   - RIGHT_TURN：向右转动
   - RIGHT_STOP：右端停留
   - LEFT_TURN：向左转动

2. **运动计算**：
   - 总时间 = (100 - 速度) × 20 × 0.25
   - 总次数 = (100 - 速度) × 0.25
   - 单次角度增量 = 摆动角度 ÷ 总次数

### 4.2 编码器处理
- **中断驱动**：使用外部中断检测编码器变化
- **去重处理**：防止信号抖动导致的误计数
- **限幅处理**：确保计数值在合理范围内

### 4.3 参数映射
- **线性映射**：使用map()函数将编码器值映射到实际参数
- **实时更新**：每100ms更新一次参数值
- **范围限制**：确保参数在安全范围内

## 5. 数据存储

### 5.1 EEPROM存储结构
系统使用JSON格式在EEPROM中存储参数：
```json
{
  "steerAngle": 90,
  "steerSpeed": 50,
  "steerLTime": 5,
  "steerRTime": 5,
  "motorSpeed": 80,
  "steerMidVal": 1550,
  "encoderValues": [50, 25, 10, 450, 60, 70, 80]
}
```

### 5.2 存储地址分配
| 参数 | 地址 | 说明 |
|------|------|------|
| 舵机角度 | 0 | 摆动角度值 |
| 舵机速度 | 1 | 摆动速度值 |
| 左停留时间 | 2 | 左端停留时间 |
| 右停留时间 | 3 | 右端停留时间 |
| 电机速度 | 4 | 电机1速度 |
| 编码器0值 | 5 | 摆动幅度编码器 |
| 编码器1值 | 6 | 摆动速度编码器 |
| 编码器2值 | 7 | 停留时间编码器 |
| 编码器4值 | 8 | 电机1速度编码器 |
| 编码器3值 | 9-10 | 中位点编码器（16位） |
| 中位点值 | 11-12 | 舵机中位点（16位） |
| 停留标志 | 13 | 停留时间模式标志 |
| 编码器5值 | 14 | 电机2速度编码器 |
| 编码器6值 | 15 | 电机3速度编码器 |
| 显示角度 | 16 | 显示用角度值 |
| 存储标志 | 200 | 参数已存储标志 |

## 6. 故障排除

### 6.1 常见问题
1. **舵机不动作**
   - 检查PWM引脚连接
   - 确认电源电压是否足够
   - 检查舵机开关状态

2. **电机不转动**
   - 检查PWM和方向引脚连接
   - 确认电机开关状态
   - 检查电源电压

3. **编码器无响应**
   - 检查CLK和DT引脚连接
   - 确认编码器电源连接
   - 检查中断引脚配置

4. **数码管不显示**
   - 检查74HC595连接
   - 确认数据、时钟、锁存引脚
   - 检查数码管电源

### 6.2 调试方法
1. **串口调试**：通过Serial输出关键参数
2. **LED指示**：使用板载LED指示系统状态
3. **参数检查**：通过数码管显示确认参数值

## 7. 扩展功能

### 7.1 可能的扩展
- **无线控制**：添加蓝牙或WiFi模块
- **传感器集成**：添加位置、速度传感器
- **上位机控制**：开发PC端控制软件
- **多轴控制**：扩展为多舵机系统

### 7.2 代码优化建议
- **模块化重构**：将功能进一步模块化
- **参数配置化**：将硬编码参数改为配置文件
- **错误处理**：添加完善的错误处理机制
- **代码注释**：增加详细的代码注释

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护人员**：系统开发者 