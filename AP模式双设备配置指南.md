# AP模式双设备配置指南

## 🎯 系统架构

```
设备1: Mega2560主设备 ←→ ESP32(AP模式) ←→ WiFi直连 ←→ ESP32(Station模式) ←→ Mega2560从设备
```

## 📋 配置步骤

### 步骤1: 准备硬件

#### 设备1 (主设备 - AP模式)
- Mega2560 + ESP32
- 连接方式：
  ```
  Mega2560主设备    ESP32主设备
  ──────────────    ──────────
  TX2 (Pin 16)  →   RX (Pin 3)
  RX2 (Pin 17)  ←   TX (Pin 1)
  GND           →   GND
  5V            →   VIN
  ```

#### 设备2 (从设备 - Station模式)
- Mega2560 + ESP32
- 连接方式：
  ```
  Mega2560从设备    ESP32从设备
  ──────────────    ──────────
  TX2 (Pin 16)  →   RX (Pin 3)
  RX2 (Pin 17)  ←   TX (Pin 1)
  GND           →   GND
  5V            →   VIN
  ```

### 步骤2: 上传程序

#### 2.1 设备1 (主设备 - AP模式)
1. **Mega2560**: 上传 `Mega2560_ESP32_主设备_完整版.ino`
2. **ESP32**: 上传 `ESP32_AP模式_主设备.ino`

#### 2.2 设备2 (从设备 - Station模式)
1. **Mega2560**: 上传 `Mega2560_ESP32_从设备_完整版.ino`
2. **ESP32**: 上传 `ESP32_Station模式_从设备.ino`

### 步骤3: 启动顺序

#### 3.1 先启动主设备
1. 启动Mega2560主设备
2. 启动ESP32主设备（AP模式）
3. 等待AP热点创建成功

#### 3.2 再启动从设备
1. 启动Mega2560从设备
2. 启动ESP32从设备（Station模式）
3. 等待连接到AP热点

## 🔧 测试步骤

### 1. 单设备测试
1. 先测试设备1，确保Mega2560与ESP32通信正常
2. 再测试设备2，确保Mega2560与ESP32通信正常

### 2. 双设备测试
1. 同时启动两个设备
2. 观察串口输出，确认AP热点创建成功
3. 观察串口输出，确认Station连接成功
4. 测试数据同步功能

### 3. 功能测试
- **编码器旋转**: 观察数据是否实时同步
- **按键操作**: 观察状态变化是否同步
- **舵机控制**: 观察舵机是否同步运动

## 📊 预期输出

### 主设备串口输出
```
ESP32 AP模式主设备启动
启动AP模式...
AP IP地址: 192.168.4.1
热点名称: ESP32_MASTER_AP
热点密码: 12345678
UDP服务器已启动，端口: 1234
AP模式启动成功！
Mega2560连接成功！
收到Mega2560数据: MASTER_DATA:106.00,4,23,3,0,1202,35,1,0,0,0,70,17,31,102,1
广播UDP数据: MASTER_DATA:106.00,4,23,3,0,1202,35,1,0,0,0,70,17,31,102,1
```

### 从设备串口输出
```
ESP32 Station模式从设备启动
正在连接WiFi热点: ESP32_MASTER_AP
WiFi连接成功！
本地IP地址: 192.168.4.2
服务器IP地址: 192.168.4.1
UDP客户端已启动，端口: 1234
Mega2560连接成功！
收到UDP数据: MASTER_DATA:106.00,4,23,3,0,1202,35,1,0,0,0,70,17,31,102,1
转发给本地Mega2560: MASTER_DATA:106.00,4,23,3,0,1202,35,1,0,0,0,70,17,31,102,1
```

## 🚨 故障排除

### 1. AP热点创建失败
- 检查ESP32是否正常工作
- 确保没有其他设备使用相同的热点名称
- 检查密码设置

### 2. Station连接失败
- 检查热点名称和密码是否正确
- 确保AP热点已创建成功
- 检查信号强度

### 3. Mega2560连接超时
- 检查接线是否正确
- 确保串口波特率一致 (115200)
- 检查电源供应

### 4. UDP通信失败
- 检查IP地址配置
- 确保UDP端口1234没有被占用
- 检查网络连接

### 5. 数据同步异常
- 检查数据格式是否正确
- 确保JSON解析正常
- 检查EEPROM读写权限

## 📝 注意事项

1. **启动顺序**: 必须先启动AP模式设备，再启动Station模式设备
2. **电源供应**: 确保ESP32有足够的电源供应
3. **接地**: 确保所有设备共地
4. **串口冲突**: 避免串口监控器冲突
5. **热点名称**: 确保热点名称唯一
6. **密码安全**: 使用强密码保护热点

## 🎉 成功标志

当看到以下输出时，表示系统配置成功：
- 主设备显示"AP模式启动成功！"
- 从设备显示"WiFi连接成功！"
- 两个设备都显示"Mega2560连接成功！"
- 数据能够正常同步
- 心跳保持正常

## 🔧 自定义配置

### 修改热点名称和密码
在 `ESP32_AP模式_主设备.ino` 中：
```cpp
const char* ap_ssid = "YourAPName";        // 修改热点名称
const char* ap_password = "YourPassword";  // 修改热点密码
```

在 `ESP32_Station模式_从设备.ino` 中：
```cpp
const char* ssid = "YourAPName";           // 与AP名称一致
const char* password = "YourPassword";     // 与AP密码一致
```

### 修改UDP端口
在两个程序中同时修改：
```cpp
const int udp_port = 1234;  // 修改为其他端口
```
